<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Momentum – AFL Card Game</title>

<!-- React + Babel -->
<script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

<style>
/* global + card + board styles (unchanged) */
body{margin:0;font-family:sans-serif;background:#222;color:#fff;text-align:center}
.card{display:inline-block;width:85px;height:120px;border-radius:8px;margin:4px;padding:6px;border:2px solid #ccc;cursor:pointer}
.red{background:#8a1b1b}.blue{background:#0d2a86}.ump{background:#555}.wild{background:#333}
.card-title{font-size:14px;font-weight:700}.card-val{font-size:20px;margin-top:6px}
.board{display:flex;flex-direction:column;height:100vh}
.hand-bar{background:#111;border-top:2px solid #444;padding:6px}
.hand{display:flex;justify-content:center;flex-wrap:wrap}
.zone{flex:1;margin:4px;border:2px solid #555;border-radius:10px;padding:6px;background:#333}
.highlight{border-color:#ffcc00;box-shadow:0 0 8px #ffcc00}
.chain{display:flex;justify-content:center;flex-wrap:wrap;margin-top:4px}
.btn{padding:12px 24px;margin:8px auto;font-weight:700;border:none;border-radius:8px;cursor:pointer;background:#ffcc00;color:#000}
/* start-screen theme */
.start{height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center;background:#f9f0ee;color:#0d2a86}
.start h1{color:#8a1b1b;letter-spacing:1px;margin:10px 0 0}
.start p{margin:0 0 10px}
.splash-card{width:240px;max-width:80%;box-shadow:0 0 10px rgba(0,0,0,.25);border-radius:6px;margin-bottom:20px}
.start button{background:#8a1b1b;color:#f9f0ee;padding:14px 32px;font-size:20px;font-weight:700;border:none;border-radius:10px;cursor:pointer}
.start button:hover{opacity:.85}
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const {useState,useEffect}=React;
const shuffle=a=>[...a].sort(()=>Math.random()-0.5);
const lastCard=a=>a.length?a[a.length-1]:null;

/* deck builder */
const COLORS=["red","blue"];
const MOM={Handball:8,Bounce:8,Kick:8,"Kick & Mark":5,Mark:5,Torp:4,Banana:4};
const DEF={Tackle:4,Smother:4,"Tackle HTB":2,"Intercept Mark":4};
const UMPS=["High Tackle","Not 15","50 Metres","Score Review"];
const VAL={Handball:1,Bounce:1,Kick:1,"Kick & Mark":1,Mark:0,Torp:3,Banana:3};
function buildDeck(){
  let d=[];
  COLORS.forEach(col=>{
    Object.entries(MOM).forEach(([n,c])=>{for(let i=0;i<c;i++)d.push({name:n,color:col,value:VAL[n],type:"mom"});} );
    Object.entries(DEF).forEach(([n,c])=>{for(let i=0;i<c;i++)d.push({name:n,color:col,type:"def"});} );
  });
  UMPS.forEach(n=>{for(let i=0;i<2;i++)d.push({name:n,color:"ump",type:"ump"});});
  d.push({name:"Siren",color:"wild",type:"wild"});
  return shuffle(d);
}
const buildScore=()=>shuffle([..."GGGGGGG",..."BBBBBBBBBBBBB"]); // 7G 13B

/* card + zone components */
const Card=({c,onClick})=>(
  <div className={`card ${c.color}`} onClick={onClick}>
    <div className="card-title">{c.name}</div>
    {c.value!=null&&<div className="card-val">+{c.value}</div>}
  </div>);
function Zone({p,current}){const m=p.chain.reduce((s,c)=>s+(c.value||0),0);
  return(<div className={`zone ${current?"highlight":""}`}><strong>{p.name}</strong><br/>Score {p.score} • Mom {m}
    <div className="chain">{p.chain.map((c,i)=><Card key={i} c={c}/>)}</div></div>);
}

/* ---------- Board with quarters ---------- */
function Board({onWin}){
  const [deck,setDeck]=useState(buildDeck());
  const [scores,setScores]=useState(buildScore());
  const [players,setPlayers]=useState(Array.from({length:4},(_,i)=>({id:i,name:i?`Bot ${i}`:"You",hand:[],chain:[],score:0})));
  const [turn,setTurn]=useState(0);
  const [actions,setActions]=useState(3);
  const [colour,setColour]=useState(null);

  /* NEW quarter state */
  const [quarter,setQuarter]=useState(1);       // 1-4
  const [turnCount,setTurnCount]=useState(0);   // 0-3 within a quarter

  const draw=p=>{if(deck.length){p.hand.push(deck[0]);setDeck(deck.slice(1));}};

  /* initial deal */
  useEffect(()=>{if(players[0].hand.length===0){const arr=[...players];arr.forEach(pl=>{while(pl.hand.length<7)draw(pl);});setPlayers(arr);}},[]);

  function handleScore(p){
    const mom=p.chain.reduce((s,c)=>s+(c.value||0),0);
    const last=lastCard(p.chain)?lastCard(p.chain).name:null;
    if(mom>=10&&["Kick","Torp","Banana"].includes(last)){
      const sc=scores[0];setScores(scores.slice(1));
      p.score+=sc==="G"?6:1;
      p.chain=sc==="G"?[]:p.chain.slice(-2);
      if(p.score>=30)onWin(p.name);
    }
  }
  function applyDef(state,src,dst,idx){
    const card=state[src].hand[idx];const chain=state[dst].chain;const last=lastCard(chain);let ok=false;
    if(card.name==="Tackle"&&last&&["Handball","Bounce"].includes(last.name)){chain.pop();ok=true;}
    else if(card.name==="Smother"&&last&&["Handball","Kick"].includes(last.name)){chain.pop();ok=true;}
    else if(card.name==="Tackle HTB"&&chain.length){state[dst].chain=[];ok=true;}
    else if(card.name==="Intercept Mark"&&last&&last.name==="Kick"){state[src].chain.push(last);chain.pop();ok=true;}
    if(ok)state[src].hand.splice(idx,1);return ok;
  }

  /* human click */
  const playCard=i=>{
    if(turn!==0||actions===0)return;
    const arr=[...players];const card=arr[0].hand[i];
    if(card.type==="mom"){
      if(colour&&card.color!==colour)return;
      arr[0].hand.splice(i,1);arr[0].chain.push(card);
      setColour(colour||card.color);setActions(a=>a-1);
      handleScore(arr[0]);while(arr[0].hand.length<7)draw(arr[0]);setPlayers(arr);
    }else if(card.type==="def"){
      const tgt=parseInt(prompt("Target player (1-3)"));if(tgt<1||tgt>3||isNaN(tgt)){alert("Invalid");return;}
      if(applyDef(arr,0,tgt,i)){setPlayers(arr);setActions(a=>a-1);}else alert("Illegal defence.");
    }
  };

  /* AI */
  useEffect(()=>{if(turn===0)return;
    const arr=[...players];const ai=arr[turn];const human=arr[0];const last=lastCard(human.chain);
    const d=ai.hand.findIndex(c=>c.type==="def"&&(
      (c.name==="Tackle"&&last&&["Handball","Bounce"].includes(last.name))||
      (c.name==="Smother"&&last&&["Handball","Kick"].includes(last.name))||
      (c.name==="Tackle HTB"&&human.chain.length)||
      (c.name==="Intercept Mark"&&last&&last.name==="Kick")));
    if(d!==-1){applyDef(arr,turn,0,d);setPlayers(arr);setTimeout(endTurn,600);return;}
    const m=ai.hand.findIndex(c=>c.type==="mom");
    if(m!==-1){ai.chain.push(ai.hand.splice(m,1)[0]);while(ai.hand.length<7)draw(ai);}
    setPlayers(arr);setTimeout(endTurn,600);
  },[turn]);

  /* NEW endTurn with quarter handling */
  const endTurn=()=>{
    // next player
    setTurn(t=>(t+1)%4);
    setActions(3);
    setColour(null);

    // turn counter & quarter rollover
    setTurnCount(tc=>{
      const next=tc+1;
      if(next===4){                    // quarter ends
        // clear all chains
        setPlayers(prev=>prev.map(pl=>({...pl,chain:[]})));
        setQuarter(q=>{
          if(q===4){
            // Game over — highest score wins
            const winner=players.reduce((max,p)=>p.score>max.score?p:max,players[0]).name;
            onWin(winner);
            return q;
          }
          return q+1;
        });
        return 0;  // reset for new quarter
      }
      return next;
    });
  };

  return(
    <div className="board">
      <h3>Q{quarter} — Turn: {players[turn].name}</h3>
      <div style={{display:"flex",justifyContent:"space-around"}}>
        {players.slice(1).map(p=><Zone key={p.id} p={p} current={turn===p.id}/>)}
      </div>
      <Zone p={players[0]} current={turn===0}/>
      <div className="hand-bar"><div className="hand">
        {players[0].hand.map((c,i)=><Card key={i} c={c} onClick={()=>playCard(i)}/>)}
      </div></div>
      {turn===0&&<button className="btn" onClick={endTurn}>End Turn ({actions})</button>}
    </div>
  );
}

/* ----- app with themed start screen ----- */
function App(){
  const [play,setPlay]=useState(false);
  const [winner,setWinner]=useState("-");
  return play?<Board onWin={n=>{setWinner(n);setPlay(false);}}/>:
   <div className="start">
     <img src="splash_card.png" alt="Momentum tackle card" className="splash-card"/>
     <h1>MOMENTUM</h1>
     <p>The Aussie Rules Card Game</p>
     {winner!=="-"&&<h2 style={{marginTop:8}}>{winner} wins!</h2>}
     <button onClick={()=>setPlay(true)}>Play Game</button>
   </div>;
}
ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
